<!doctype html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

    <head>
        <meta charset="utf-8">

        <title>PNG-Editor</title>
        <meta name="description" content="">

        <!-- Mobile viewport optimization h5bp.com/ad -->
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width">

        <!-- Home screen icon  Mathias Bynens mathiasbynens.be/notes/touch-icons -->
        <!-- For iPhone 4 with high-resolution Retina display: -->
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/h/apple-touch-icon.png">
        <!-- For first-generation iPad: -->
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/m/apple-touch-icon.png">
        <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
        <link rel="apple-touch-icon-precomposed" href="img/l/apple-touch-icon-precomposed.png">
        <!-- For nokia devices: -->
        <link rel="shortcut icon" href="img/l/apple-touch-icon.png">

        <!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
        <!-- <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
        <!-- <script>(function(){var a;if(navigator.platform==="iPad"){a=window.orientation!==90||window.orientation===-90?"img/startup-tablet-landscape.png":"img/startup-tablet-portrait.png"}else{a=window.devicePixelRatio===2?"img/startup-retina.png":"img/startup.png"}document.write('<link rel="apple-touch-startup-image" href="'+a+'"/>')})()</script> -->

        <!-- The script prevents links from opening in mobile safari. https://gist.github.com/1042026 -->
        <!-- <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script> -->

        <!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading -->
        <meta http-equiv="cleartype" content="on">

        <!-- more tags for your 'head' to consider h5bp.com/d/head-Tips -->

        <style media="screen" type="text/css">
            #PNGEditorDiv input,
            #PNGEditorDiv textarea {
                font-family: monospace;
            }
        </style>

        <!-- Main Stylesheet -->
        <link rel="stylesheet" href="css/style.css">

        <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
        <script src="js/libs/modernizr-2.0.6.min.js"></script>
    </head>

    <body>

        <div id="container">
            <header>
                <h1>PNG-Editor</h1>

            </header>
            <div id="main" role="main">
                <nav>
                    <ul>
                        <li><a href="#UploadFileDiv">Upload file</a></li>
                        <li><a href="#PNGEditorDiv">PNG editor</a></li>
                        <li><a href="#EditedImageDiv">Edited Image</a></li>
                        <li><a href="#OriginalImageDiv">Original image</a></li>
                    </ul>
                </nav>
                <div id="UploadFileDiv">
                    <form name="file-form">
                        <input type="file" name="image-file" />
                    </form>
                </div>

                <div id="PNGEditorDiv"></div>

                <div id="EditedImageDiv">
                    <img id="edited-image-img" alt="Edited Image" name="EditedImageImg" width="100" height="100" src="" />
                </div>
                <div id="OriginalImageDiv">
                    <img id="original-image-img" alt="Original Image" name="OriginalImageImg" width="100" height="100" src="" />
                </div>
            </div>

            <footer>
                <hr/>
                <small>&copy; 2013 ag</small>

            </footer>
        </div> <!--! end of #container -->


        <!-- JavaScript at the bottom for fast page loading -->
        <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>

        <!-- scripts concatenated and minified via ant build script-->
        <script src="js/helper.js"></script>
        <script src="js/png-editor/base64.js"></script>
        <script>
            /**
             * Byte Array to hexadecimal string
             * @param {ByteArray} bytes
             * @returns {String} white-spaces padded hexadecimal representation
             *          of the input array
             */
            function batohexs(bytes) {
                var result = '';
                if (bytes) {
                    var hexDigits = '0123456789ABCDEF';
                    var length = bytes.length;
                    for (var i = 0; i < length; ++i) {
                        result += hexDigits[bytes[i] >> 4] + hexDigits[bytes[i] & 0x0f] + ' ';
                    }
                }
                return result;
            }

            /**
             *  ByteArray to 32 bit integer
             *  @param {ByteArray} bytes 4 bytes in network order
             *  @return {Number} 32 bit integer
             */
            function batoi(bytes) {
                var val = 0;
                for (var i = 0; i < 4; ++i) {
                    val *= 256;
                    val += bytes[i];
                }
                return val;
            }

            /**
             *  ByteArray to String interpreting each byte as char codes
             *  @param {ByteArray} bytes in network order
             *  @return {String}
             */
            function batos(bytes) {
                var result = '';
                for (var i = 0; i < bytes.length; ++i) {
                    result += String.fromCharCode(bytes[i]);
                }
                return result;
            }

            /**
             * @see <a href="http://stackoverflow.com/a/5370394/413020">Convert
             *      array of byte values to base64 encoded string and break long
             *      lines, Javascript (code golf)</a>
             * @param {ByteArray} input
             * @returns {String} base64-encoded input buffer
             */
            function batobase64(input) {
                var str = "";
                for (var i = 0; i < input.length; i++) {
                    str += String.fromCharCode(input[i]);
                }
                return btoa(str).replace(/.{76}(?=.)/g, '$&\n');
            }
            ;

            /**
             * @see <a href="http://stackoverflow.com/a/2117523/413020">How to
             *      create a GUID / UUID in Javascript?</a>
             * @returns {String} rfc4122 ver 4 compliant guid
             */
            function guid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            /**
             * @param {ByteArray} bytes
             * @param {Number} ptr pointer to the start of the chunk in the
             *       byte array
             */
            function Chunk(bytes, ptr) {
                var _ptr = ptr;
                var _lengthHex = batohexs(bytes.subarray(_ptr, _ptr + 4));
                var _length = batoi(bytes.subarray(_ptr, _ptr + 4));
                _ptr += 4;
                var _nameHex = batohexs(bytes.subarray(_ptr, _ptr + 4));
                var _name = batos(bytes.subarray(_ptr, _ptr + 4));
                _ptr += 4;
                var _dataHex = batohexs(bytes.subarray(_ptr, _ptr + _length));
                var _data = bytes.subarray(_ptr, _ptr + _length);
                _ptr += _length;
                var _crcHex = batohexs(bytes.subarray(_ptr, _ptr + 4));
                var _crc = batoi(bytes.subarray(_ptr, _ptr + 4));
                _ptr += 4;

                /**
                 * @returns {String}
                 */
                this.getLengthHex = function() {
                    return _lengthHex;
                };
                /**
                 * @returns {String}
                 */
                this.getLengthDec = function() {
                    return '' + _length;
                };
                /**
                 * @returns {Number} chunk's length
                 */
                this.getLength = function() {
                    return _length + 4 + 4 + 4; // length + name + crc
                };
                /**
                 * @returns {String}
                 */
                this.getNameHex = function() {
                    return _nameHex;
                };
                /**
                 * @returns {String}
                 */
                this.getName = function() {
                    return _name;
                };
                /**
                 * @returns {String}
                 */
                this.getDataHex = function() {
                    return _dataHex;
                };
                /**
                 * @returns {ByteArray}
                 */
                this.getData = function() {
                    return _data;
                };
                /**
                 * @returns {String}
                 */
                this.getCrcHex = function() {
                    return _crcHex;
                };
                /**
                 * @returns {Number}
                 */
                this.getCrc = function() {
                    return _crc;
                };
            }

            /**
             * API to access png data
             * @param {ByteArray} bytes png data
             */
            function PngImage(bytes) {
                var _bytes = bytes;
                var WIDTH_PTR = 8 + 4 + 4; // Signature + IHDR's length + Chunks' name
                var HEIGHT_IND = WIDTH_PTR + 4;
                var _signature = bytes.subarray(0, 8);
                var _width = batoi(bytes.subarray(WIDTH_PTR, WIDTH_PTR + 4));
                var _height = batoi(bytes.subarray(HEIGHT_IND, HEIGHT_IND + 4));
                var _chunks = {};

                // pointer to the index in the byte array of the next chunk to read
                var _ptr = 8;
                var _nChunks = 0;

                // read chunks
                console.log('Reading chunks...');
                while (_ptr < bytes.length) {
                    var c = new Chunk(_bytes, _ptr);
                    console.log('Read chunk named "' + c.getName() + '" of length ' + c.getLength() + ' bytes.');
                    _chunks[c.getName()] = c;
                    _ptr += c.getLength();
                    ++_nChunks;
                }
                console.log(_nChunks + ' chunks read');

                /**
                 * @param {Element} tag where to render the image
                 */
                this.renderInImg = function(tag) {
                    var encodedBytes = batobase64(_bytes);
                    tag.setAttribute('src', 'data:image/png;base64,' + encodedBytes);
                    tag.setAttribute('width', '' + this.getWidth());
                    tag.setAttribute('height', '' + this.getHeight());
                };

                /**
                 * @returns {String}
                 */
                this.getSignatureHex = function() {
                    return batohexs(_signature);
                };

                /**
                 * @returns {Number}
                 */
                this.getWidth = function() {
                    return _width;
                };

                /**
                 * @returns {Number}
                 */
                this.getHeight = function() {
                    return _height;
                };

                /**
                 * @returns {Array} map of chunks
                 */
                this.getChunks = function() {
                    return _chunks;
                };
            }

            /**
             * @class Provides the API to create the PNG GUI
             * @param {Element} gUIDiv where to append the html
             * @param {PngImage} pngImage
             * @returns {PngEditor} this for method chaining
             */
            function PngEditor(gUIDiv, pngImage) {
                var _pngImage = pngImage;
                var _viewportJQuery;

                /**
                 * @returns {Element}
                 */
                var _createSignatureGUI = function() {
                    var div = $('<div>'
                            + '<header>File signature</header>'
                            + '<label>Signature</label>'
                            + '</div>');
                    div.append(
                            $('<input name="signature-textarea" type="text" size="24" readonly="readonly"/>')
                            .attr('value', _pngImage.getSignatureHex()));
                    return div;
                };

                /**
                 * 
                 * @param {Chunk} chunk
                 * @param {Number} index which chunk it is
                 * @returns {jQuery} GUI element
                 */
                var _createChunkGUI = function(chunk, index) {
                    var div = $('<div><header>Chunk ' + index + ': ' + chunk.getName() + '</header>');

                    var LENGTH_WIDTH = Math.ceil(Math.log(Math.pow(2,32)-1)/Math.log(10)); // Max length
                    // Length
                    div.append($('<label>Length</label>'))
                            .append($('<input name="chunk-0-length-textarea" type="text" size="12" value="' + chunk.getLengthHex() + '"/>'))
                            .append($('<input name="chunk-0-length-ascii-textarea" type="text" size="' + LENGTH_WIDTH + '" value="' + chunk.getLengthDec() + '"/><sub>bytes</sub>'));

                    // Type/Name
                    div.append($('<label>Type/Name</label>'))
                            .append($('<input name="chunk-0-type-textarea" type="text" size="12" value="' + chunk.getNameHex() + '"/>'))
                            .append($('<input name="chunk-0-type-ascii-textarea" type="text" size="4" value="' + chunk.getName() + '"/><sub>ASCII</sub></label>'));

                    // Data
                    div.append($('<label>Data</label>'))
                            .append($('<textarea name="chunk-0-data-textarea" rows="4" cols="50">' + chunk.getDataHex() + '</textarea>'));

                    // CRC
                    div.append($('<label>CRC</label>'))
                            .append($('<input name="chunk-0-crc-textarea" type="text" size="12" value="' + chunk.getCrcHex() + '"/>'))
                            .append($('<input name="chunk-0-crc-ascii-textarea" type="text" size="10"  value="' + chunk.getCrc() + '"/><sub>dec</sub>'));

                    return div;
                };

                var _createChunksGUI = function() {
                    var div = $('<div><div/>');
                    var names = Object.keys(_pngImage.getChunks());
                    console.log('chunks:' + names.length);
                    for (var i = 0; i < names.length; ++i) {
                        div.append(_createChunkGUI(_pngImage.getChunks()[names[i]], i));
                    }
                    return div;
                };

                var _redraw = function() {
                    _pngImage.renderInImg(_viewportJQuery[0]);
                };

                /**
                 * @param {Element} viewportTag
                 * @return {PngEditor} this for method chaining
                 */
                this.setImageViewport = function(viewportTag) {
                    _viewportJQuery = $(viewportTag);
                    _redraw();
                    return this;
                };

                this.refresh = function() {
                    $(gUIDiv).empty().append(_element);
                };

                var _element = $('<div><div/>')
                        .append(_createSignatureGUI())
                        .append(_createChunksGUI());


                return this;
            }

            document.forms['file-form'].elements['image-file'].onchange = function(evt) {
                if (!window.FileReader)
                    return; // Browser is not compatible

                var reader = new FileReader();

                reader.onload = function(evt) {
                    if (evt.target.readyState !== 2)
                        return;
                    if (evt.target.error) {
                        alert('Error while reading file');
                        return;
                    }

                    var pngBytes = new Uint8Array(evt.target.result);
                    var pngImage = new PngImage(pngBytes);

                    // Render original image
                    pngImage.renderInImg($('#original-image-img')[0]);

                    // Re-create GUI editor and refresh image
                    new PngEditor($('#PNGEditorDiv')[0], pngImage)
                            .setImageViewport($('#edited-image-img')[0])
                            .refresh();
                };

                reader.readAsArrayBuffer(evt.target.files[0]);
            };
        </script>
        <!-- end scripts-->

        <!-- Debugger - remove for production -->
        <!-- <script src="https://getfirebug.com/firebug-lite.js"></script> -->
    </body>
</html>